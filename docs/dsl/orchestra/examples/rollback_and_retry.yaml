version: 1.0

description: >
  A sample workflow that demonstrates how to handle rollback and retry on error. 
  In this example, the workflow will loop until the file /tmp/done exists. A
  parallel task will wait for some time before creating the file. When completed,
  /tmp/done will be deleted.

vars:
  count: 0
  tries: 3

tasks:
  init:
    action: core.local cmd="rm -f /tmp/done"
    on-complete:
      - if: <% state() = "succeeded" %>
        next: check-file, wait-create-file

  check-file:
    action: core.local
    input:
      cmd: >
        echo 'Do something useful here.';
        if [ ! -e '/tmp/done' ]; then exit 1; fi
    on-complete:
      - if: <% state() = "succeeded" %>
        next: delete-file
      - if: <% state() = "failed" %>
        next: rollback

  rollback:
    action: core.local
    input:
      cmd: >
        echo 'Rollback something here.';
    on-complete:
      - if: <% $.count < $.tries %>
        publish: count=<% $.count + 1 %>
        next: check-file
      - if: <% $.count >= $.tries %>
        next: fail

  wait-create-file:
    action: core.local cmd="sleep 10; touch /tmp/done"

  delete-file:
    action: core.local cmd="rm -f /tmp/done"
