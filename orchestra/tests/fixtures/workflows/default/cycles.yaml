version: 1.0

description: A sample workflow with multiple cycles.

input:
  - count: 0

tasks:
  prep:
    action: std.noop
    on-complete:
      - if: <% task_state(prep) = "SUCCESS" %>
        next:
          - task1
  task1:
    action: std.noop
    on-complete:
      - if: <% task_state(task1) = "SUCCESS" %>
        publish:
          proceed: False
        next:
          - task2
  task2:
    action: std.noop
    on-complete:
      - if: <% task_state(task2) = "SUCCESS" and not $.proceed %>
        next:
          - task3
      - if: <% task_state(task2) = "SUCCESS" and $.proceed %>
        next:
          - task5
  task3:
    action: std.noop
    on-complete:
      - if: <% task_state(task3) = "SUCCESS" %>
        next:
          - task4
  task4:
    action: std.noop
    on-complete:
      - if: <% task_state(task4) = "SUCCESS" %>
        publish:
          proceed: True
        next:
          - task2
  task5:
    action: std.noop
    on-complete:
      - if: <% task_state(task5) = "SUCCESS" and $.count < 3 %>
        publish:
          count: <% $.count + 1 %>
        next:
          - task1
